name: Master Archivist (Self-Contained)

on:
  push:
    paths:
      - '**/*.html'
      - '.github/workflows/update-index.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Run Archivist Logic
        run: |
          # We write the python script on the fly to avoid file issues
          cat <<EOF > archivist_temp.py
          import os
          import re

          MARKER_START = ""
          MARKER_END = ""
          EXCLUDE_DIRS = {'.git', '.github', 'scripts', 'css', 'img'}
          EXCLUDE_FILES = {'index.html', '404.html', 'CNAME'}

          def get_title(filepath):
              try:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()
                      match = re.search(r'<title>(.*?)</title>', content, re.IGNORECASE | re.DOTALL)
                      if match:
                          return match.group(1).strip().replace('| Standard Syntax Entity Verified', '')
              except Exception:
                  pass
              return os.path.basename(filepath)

          def generate_list_item(filename, title, is_collection=False):
              if is_collection:
                  return f'<li><span class="dir-badge" style="background:#005f87;color:#fff;padding:2px 6px;font-size:10px;text-transform:uppercase;margin-right:10px">Collection</span><a href="{filename}/index.html" style="text-decoration:none;color:#111;font-weight:700;display:inline-block">üìÇ {title} Vault</a></li>'
              else:
                  return f'<li><span class="badge" style="background:#000;color:#fff;padding:2px 6px;font-size:10px;text-transform:uppercase;margin-right:10px">Entity</span><a href="{filename}" style="text-decoration:none;color:#111;font-weight:500;display:inline-block">{title}</a></li>'

          def update_index(directory):
              index_path = os.path.join(directory, 'index.html')
              files = []
              folders = []
              
              # Scan directory
              with os.scandir(directory) as entries:
                  for entry in entries:
                      if entry.name in EXCLUDE_FILES or entry.name.startswith('.'): continue
                      
                      if entry.is_file() and entry.name.endswith('.html'):
                          title = get_title(entry.path)
                          files.append((entry.name, title))
                      elif entry.is_dir() and entry.name not in EXCLUDE_DIRS:
                          update_index(entry.path) # Recursion
                          folders.append((entry.name, entry.name.capitalize()))

              # Sort
              files.sort(key=lambda x: x[1])
              folders.sort(key=lambda x: x[1])

              # Build HTML
              html_lines = []
              for folder_name, folder_title in folders:
                  html_lines.append(generate_list_item(folder_name, folder_title, is_collection=True))
              for file_name, file_title in files:
                  html_lines.append(generate_list_item(file_name, file_title))

              new_list_content = "\\n        ".join(html_lines) or "<li>No verified entities found.</li>"

              # Write to file
              if os.path.exists(index_path):
                  with open(index_path, 'r', encoding='utf-8') as f:
                      original_content = f.read()
                  
                  pattern = re.compile(f'({re.escape(MARKER_START)})(.*?)({re.escape(MARKER_END)})', re.DOTALL)
                  if pattern.search(original_content):
                      updated_content = pattern.sub(f'\\1\\n        {new_list_content}\\n        \\3', original_content)
                      if updated_content != original_content:
                          with open(index_path, 'w', encoding='utf-8') as f:
                              f.write(updated_content)
                          print(f"‚úÖ Updated: {index_path}")
                  else:
                      print(f"‚ö†Ô∏è Skipped: {index_path} (Missing Markers)")
              else:
                   # Auto-create index for subfolders
                   print(f"Creating new index for {directory}")
                   with open(index_path, 'w') as f:
                       f.write(f"<!DOCTYPE html><html><head><title>Index</title></head><body><ul>{MARKER_START}\\n{new_list_content}\\n{MARKER_END}</ul></body></html>")

          if __name__ == "__main__":
              update_index('.')
          EOF
          
          # Run the generated script
          python archivist_temp.py
          
          # Cleanup
          rm archivist_temp.py

      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ü§ñ Bulletproof Archivist: Index Update"
          file_pattern: "**/*.html"
